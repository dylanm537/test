name: ShipTester
on: 
  workflow_dispatch:
  workflow_call:
  workflow_run:
    workflows: ["Build"]
    types: [completed]
    branches: ["main"]

jobs:
  ship-job:
    permissions:
        actions: read
    runs-on: ubuntu-latest
    steps:      
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Docker Container
        run: docker build --tag test .

      - name: Run
        run: docker run -i test

      - name: Get Artifact from Build Workflow
        uses: actions/download-artifact@v4
        with:
          name: go-binary
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          path: test
      
      - name: Add The SSH Key
        env: 
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run:
          mkdir -p /tmp/runner/.ssh/known_hosts
          
          ssh-keyscan tst-sdk-app-server.critical.blue >> /home/runner/.ssh/known_hosts
          echo "test" > /home/runner/.ssh/github_actions
          chmod 600 /home/runner/.ssh/github_actions
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add /home/runner/.ssh/github_actions

      - name: Test Artifact
        run: go run test

      - name: Stop containter thing
        run: exit
